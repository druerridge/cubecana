<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Card List Converter</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }
        textarea {
            width: 100%;
            height: 300px;
        }
        button {
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <h1>Dreamborn Cube Converter</h1>
    <textarea id="cardList" placeholder="dreamborn.ink > your cube > export to TTS > open json file > paste contents here > press convert"></textarea>
    <br>
    <button id="convertButton">Convert</button>
    <button id="downloadButton" disabled>Download</button>

    <script>
        // function convertCardList() {
        //     const cardList = document.getElementById('cardList').value;
        //     fetch('/convert-endpoint', {
        //         method: 'POST',
        //         headers: {
        //             'Content-Type': 'application/json'
        //         },
        //         body: JSON.stringify({ cardList: cardList })
        //     })
        //     .then(response => response.text())
        //     .then(data => {
        //         const blob = new Blob([data], { type: 'text/plain' });
        //         const url = URL.createObjectURL(blob);
        //         const downloadButton = document.getElementById('downloadButton');
        //         downloadButton.href = url;
        //         downloadButton.download = 'custom-cube.draftmancer.txt';
        //         downloadButton.disabled = false;
        //     })
        //     .catch(error => console.error('Error:', error));
        // }

        // function downloadFile() {
        //     // This function is intentionally left blank as the download is handled by the browser
        // }

    const cardList = document.getElementById('cardList').value;
    const convertButton = document.getElementById('convertButton');
    const downloadButton = document.getElementById('downloadButton');

    function download(data, filename, type) {
        var file = new Blob([data], {type: type});
        if (window.navigator.msSaveOrOpenBlob) // IE10+
            window.navigator.msSaveOrOpenBlob(file, filename);
        else { // Others
            var a = document.createElement("a"),
                    url = URL.createObjectURL(file);
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            setTimeout(function() {
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);  
            }, 0); 
        }
    }

    convertButton.addEventListener('click', async _ => {
        const cardList = document.getElementById('cardList').value.trim();
        var xhr = new XMLHttpRequest();
        var url = "/dreamborn-to-draftmancer/";
        xhr.open("POST", url, true);
        xhr.setRequestHeader("Content-Type", "application/json");
        xhr.onreadystatechange = function () {
            console.log("status: " + xhr.status);
            if (xhr.readyState === 4 && xhr.status === 200) {
                console.log("responseText: " + xhr.responseText);
                // ttsOutputArea.value = xhr.responseText;
                // var json = JSON.parse(xhr.responseText);
                // druDownload(xhr.responseText, "tts-cube-deck", "json");
                downloadButton.addEventListener('click', async _ => {
                    download(xhr.responseText, "custom-cube.draftmancer.txt", "txt");
                })
                downloadButton.disabled = false;
            } else {
                console.log("status: " + xhr.status);
            }
        };
        var data = JSON.stringify({ "dreamborn_export": cardList });
        xhr.send(data);
    }
    );
    </script>
</body>
</html>